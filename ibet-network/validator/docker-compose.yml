version: '3'
services:
  ibet-validator-0:
    hostname: ibet-validator-0
    build:
      context: .
    ports:
      - '30303:30303'
      - '8545:8545'
    environment:
      - PRIVATE_CONFIG=ignore
      - rpccorsdomain=*
      - rpcvhosts=*
      - nodekeyhex=25c8dd2e3cd039370706426ae49d192009ad3f3616aed2611a8cda152faccf99
    networks:
      app_net:
        ipv4_address: 172.16.239.10
    restart: always
    command:
      - /bin/sh
      - -c
      - |
        mkdir -p /eth/geth
        echo '{"config":{"chainId":1500002,"homesteadBlock":1,"eip150Block":2,"eip150Hash":"0x0000000000000000000000000000000000000000000000000000000000000000","eip155Block":3,"eip158Block":3,"byzantiumBlock":3,"istanbul":{"epoch":30000,"policy":0},"isQuorum":true},"nonce":"0x0","timestamp":"0x5b30a79f","extraData":"0x0000000000000000000000000000000000000000000000000000000000000000f89af8549455718e72e048375d824233e8139a7df791c9922c949dd59c486f1a307c92946ad373f28f10b1d3623294301c2945de770f93700d0b4371d59d1a81d2fdf5943a8b94e5774baa7f9b6c9ef28859dc8fd7577c5bb8410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0","gasLimit":"0x2faf0800","difficulty":"0x1","mixHash":"0x63746963616c2062797a616e74696e65206661756c7420746f6c6572616e6365","coinbase":"0x0000000000000000000000000000000000000000","constantinopleBlock":0,"petersburgBlock":0,"istanbulBlock":0,"alloc":{"301c2945de770f93700d0b4371d59d1a81d2fdf5":{"balance":"0x446c3b15f9926687d2c40534fdb564000000000000"},"3a8b94e5774baa7f9b6c9ef28859dc8fd7577c5b":{"balance":"0x446c3b15f9926687d2c40534fdb564000000000000"},"55718e72e048375d824233e8139a7df791c9922c":{"balance":"0x446c3b15f9926687d2c40534fdb564000000000000"},"9dd59c486f1a307c92946ad373f28f10b1d36232":{"balance":"0x446c3b15f9926687d2c40534fdb564000000000000"}},"number":"0x0","gasUsed":"0x0","parentHash":"0x0000000000000000000000000000000000000000000000000000000000000000"}' > /eth/genesis.json
        echo '["enode://3e071efa9d4a077c0e830cdec671549a0fe25db98378d8835aad225e2c8c60ef9a71f044d52dbc52c7a394af010b4cfec3915f8ea1ed325a2120c5afa990335b@172.16.239.10:30303?discport=0","enode://4f1ff168f765a7cc3edb566809432c9e7e2974d90f4b7f0ec35b4ef57e04a64699e56743064612935d7634d4d251f50d1abd190750b07282e3782716a7158f44@172.16.239.11:30303?discport=0","enode://f8ccf8207c8d1a6840094b530e8c23c3f713471227907a7d46504783dcbe46214ad9c7d4e76995c1028ada436bd412f20d57b75e3af0ff37d06c4eeee79d73b8@172.16.239.12:30303?discport=0","enode://8fc7140439978b1774df19662aec6575606f8d3a2f4eb76467662e56d59378ebe12e4bbdab8581f5d8227a2aee53ede956399b71ccd0fd61c598a982b2d6f6b7@172.16.239.13:30303?discport=0"]' > /eth/geth/static-nodes.json
        /run.sh
  ibet-validator-1:
    hostname: ibet-validator-1
    build:
      context: .
    ports:
      - '30304:30303'
      - '8546:8545'
    environment:
      - PRIVATE_CONFIG=ignore
      - rpccorsdomain=*
      - rpcvhosts=*
      - nodekeyhex=82c8c1a970dd1b6e43c89cbd4c35cf17b2e3ca72ffd74d221595db2c7c872611
    networks:
      app_net:
        ipv4_address: 172.16.239.11
    restart: always
    command:
      - /bin/sh
      - -c
      - |
        mkdir -p /eth/geth
        echo '{"config":{"chainId":1500002,"homesteadBlock":1,"eip150Block":2,"eip150Hash":"0x0000000000000000000000000000000000000000000000000000000000000000","eip155Block":3,"eip158Block":3,"byzantiumBlock":3,"istanbul":{"epoch":30000,"policy":0},"isQuorum":true},"nonce":"0x0","timestamp":"0x5b30a79f","extraData":"0x0000000000000000000000000000000000000000000000000000000000000000f89af8549455718e72e048375d824233e8139a7df791c9922c949dd59c486f1a307c92946ad373f28f10b1d3623294301c2945de770f93700d0b4371d59d1a81d2fdf5943a8b94e5774baa7f9b6c9ef28859dc8fd7577c5bb8410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0","gasLimit":"0x2faf0800","difficulty":"0x1","mixHash":"0x63746963616c2062797a616e74696e65206661756c7420746f6c6572616e6365","coinbase":"0x0000000000000000000000000000000000000000","constantinopleBlock":0,"petersburgBlock":0,"istanbulBlock":0,"alloc":{"301c2945de770f93700d0b4371d59d1a81d2fdf5":{"balance":"0x446c3b15f9926687d2c40534fdb564000000000000"},"3a8b94e5774baa7f9b6c9ef28859dc8fd7577c5b":{"balance":"0x446c3b15f9926687d2c40534fdb564000000000000"},"55718e72e048375d824233e8139a7df791c9922c":{"balance":"0x446c3b15f9926687d2c40534fdb564000000000000"},"9dd59c486f1a307c92946ad373f28f10b1d36232":{"balance":"0x446c3b15f9926687d2c40534fdb564000000000000"}},"number":"0x0","gasUsed":"0x0","parentHash":"0x0000000000000000000000000000000000000000000000000000000000000000"}' > /eth/genesis.json
        echo '["enode://3e071efa9d4a077c0e830cdec671549a0fe25db98378d8835aad225e2c8c60ef9a71f044d52dbc52c7a394af010b4cfec3915f8ea1ed325a2120c5afa990335b@172.16.239.10:30303?discport=0","enode://4f1ff168f765a7cc3edb566809432c9e7e2974d90f4b7f0ec35b4ef57e04a64699e56743064612935d7634d4d251f50d1abd190750b07282e3782716a7158f44@172.16.239.11:30303?discport=0","enode://f8ccf8207c8d1a6840094b530e8c23c3f713471227907a7d46504783dcbe46214ad9c7d4e76995c1028ada436bd412f20d57b75e3af0ff37d06c4eeee79d73b8@172.16.239.12:30303?discport=0","enode://8fc7140439978b1774df19662aec6575606f8d3a2f4eb76467662e56d59378ebe12e4bbdab8581f5d8227a2aee53ede956399b71ccd0fd61c598a982b2d6f6b7@172.16.239.13:30303?discport=0"]' > /eth/geth/static-nodes.json
        /run.sh
  ibet-validator-2:
    hostname: ibet-validator-2
    build:
      context: .
    ports:
      - '30305:30303'
      - '8547:8545'
    environment:
      - PRIVATE_CONFIG=ignore
      - rpccorsdomain=*
      - rpcvhosts=*
      - nodekeyhex=9af9ce010d37a18f89228e4ad84791fa07a95db3f69b8c52981d3c86a83e38da
    networks:
      app_net:
        ipv4_address: 172.16.239.12
    restart: always
    command:
      - /bin/sh
      - -c
      - |
        mkdir -p /eth/geth
        echo '{"config":{"chainId":1500002,"homesteadBlock":1,"eip150Block":2,"eip150Hash":"0x0000000000000000000000000000000000000000000000000000000000000000","eip155Block":3,"eip158Block":3,"byzantiumBlock":3,"istanbul":{"epoch":30000,"policy":0},"isQuorum":true},"nonce":"0x0","timestamp":"0x5b30a79f","extraData":"0x0000000000000000000000000000000000000000000000000000000000000000f89af8549455718e72e048375d824233e8139a7df791c9922c949dd59c486f1a307c92946ad373f28f10b1d3623294301c2945de770f93700d0b4371d59d1a81d2fdf5943a8b94e5774baa7f9b6c9ef28859dc8fd7577c5bb8410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0","gasLimit":"0x2faf0800","difficulty":"0x1","mixHash":"0x63746963616c2062797a616e74696e65206661756c7420746f6c6572616e6365","coinbase":"0x0000000000000000000000000000000000000000","constantinopleBlock":0,"petersburgBlock":0,"istanbulBlock":0,"alloc":{"301c2945de770f93700d0b4371d59d1a81d2fdf5":{"balance":"0x446c3b15f9926687d2c40534fdb564000000000000"},"3a8b94e5774baa7f9b6c9ef28859dc8fd7577c5b":{"balance":"0x446c3b15f9926687d2c40534fdb564000000000000"},"55718e72e048375d824233e8139a7df791c9922c":{"balance":"0x446c3b15f9926687d2c40534fdb564000000000000"},"9dd59c486f1a307c92946ad373f28f10b1d36232":{"balance":"0x446c3b15f9926687d2c40534fdb564000000000000"}},"number":"0x0","gasUsed":"0x0","parentHash":"0x0000000000000000000000000000000000000000000000000000000000000000"}' > /eth/genesis.json
        echo '["enode://3e071efa9d4a077c0e830cdec671549a0fe25db98378d8835aad225e2c8c60ef9a71f044d52dbc52c7a394af010b4cfec3915f8ea1ed325a2120c5afa990335b@30.0.11.34:30303?discport=0","enode://4f1ff168f765a7cc3edb566809432c9e7e2974d90f4b7f0ec35b4ef57e04a64699e56743064612935d7634d4d251f50d1abd190750b07282e3782716a7158f44@30.0.11.221:30303?discport=0","enode://f8ccf8207c8d1a6840094b530e8c23c3f713471227907a7d46504783dcbe46214ad9c7d4e76995c1028ada436bd412f20d57b75e3af0ff37d06c4eeee79d73b8@30.0.11.188:30303?discport=0","enode://8fc7140439978b1774df19662aec6575606f8d3a2f4eb76467662e56d59378ebe12e4bbdab8581f5d8227a2aee53ede956399b71ccd0fd61c598a982b2d6f6b7@30.0.13.245:30303?discport=0"]' > /eth/geth/static-nodes.json
        /run.sh
  ibet-validator-3:
    hostname: ibet-validator-3
    build:
      context: .
    ports:
      - '30306:30303'
      - '8548:8545'
    environment:
      - PRIVATE_CONFIG=ignore
      - rpccorsdomain=*
      - rpcvhosts=*
      - nodekeyhex=208c4075359648934d2320cd09d5417436371d77f5c61413df257f250bf03af7
    networks:
      app_net:
        ipv4_address: 172.16.239.13
    restart: always
    command:
      - /bin/sh
      - -c
      - |
        mkdir -p /eth/geth
        echo '{"config":{"chainId":1500002,"homesteadBlock":1,"eip150Block":2,"eip150Hash":"0x0000000000000000000000000000000000000000000000000000000000000000","eip155Block":3,"eip158Block":3,"byzantiumBlock":3,"istanbul":{"epoch":30000,"policy":0},"isQuorum":true},"nonce":"0x0","timestamp":"0x5b30a79f","extraData":"0x0000000000000000000000000000000000000000000000000000000000000000f89af8549455718e72e048375d824233e8139a7df791c9922c949dd59c486f1a307c92946ad373f28f10b1d3623294301c2945de770f93700d0b4371d59d1a81d2fdf5943a8b94e5774baa7f9b6c9ef28859dc8fd7577c5bb8410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0","gasLimit":"0x2faf0800","difficulty":"0x1","mixHash":"0x63746963616c2062797a616e74696e65206661756c7420746f6c6572616e6365","coinbase":"0x0000000000000000000000000000000000000000","constantinopleBlock":0,"petersburgBlock":0,"istanbulBlock":0,"alloc":{"301c2945de770f93700d0b4371d59d1a81d2fdf5":{"balance":"0x446c3b15f9926687d2c40534fdb564000000000000"},"3a8b94e5774baa7f9b6c9ef28859dc8fd7577c5b":{"balance":"0x446c3b15f9926687d2c40534fdb564000000000000"},"55718e72e048375d824233e8139a7df791c9922c":{"balance":"0x446c3b15f9926687d2c40534fdb564000000000000"},"9dd59c486f1a307c92946ad373f28f10b1d36232":{"balance":"0x446c3b15f9926687d2c40534fdb564000000000000"}},"number":"0x0","gasUsed":"0x0","parentHash":"0x0000000000000000000000000000000000000000000000000000000000000000"}' > /eth/genesis.json
        echo '["enode://3e071efa9d4a077c0e830cdec671549a0fe25db98378d8835aad225e2c8c60ef9a71f044d52dbc52c7a394af010b4cfec3915f8ea1ed325a2120c5afa990335b@30.0.11.34:30303?discport=0","enode://4f1ff168f765a7cc3edb566809432c9e7e2974d90f4b7f0ec35b4ef57e04a64699e56743064612935d7634d4d251f50d1abd190750b07282e3782716a7158f44@30.0.11.221:30303?discport=0","enode://f8ccf8207c8d1a6840094b530e8c23c3f713471227907a7d46504783dcbe46214ad9c7d4e76995c1028ada436bd412f20d57b75e3af0ff37d06c4eeee79d73b8@30.0.11.188:30303?discport=0","enode://8fc7140439978b1774df19662aec6575606f8d3a2f4eb76467662e56d59378ebe12e4bbdab8581f5d8227a2aee53ede956399b71ccd0fd61c598a982b2d6f6b7@30.0.13.245:30303?discport=0"]' > /eth/geth/static-nodes.json
        /run.sh
  epirus-api:
    image: web3labs/epirus-free-api:latest
    environment:
      - NODE_ENDPOINT=http://ibet-validator-0:8545
      - MONGO_CLIENT_URI=mongodb://epirus-mongodb:27017
      - REINDEX_ENDPOINT=http://epirus-ingestion/reindex/
      - MONGO_DB_NAME=epirus
    depends_on:
      - epirus-mongodb
      - ibet-validator-0
    networks:
      app_net:
        ipv4_address: 172.16.239.20
  epirus-mongodb:
    image: mongo:latest
    entrypoint: mongod --logpath=/dev/null --bind_ip "0.0.0.0"
    networks:
      app_net:
        ipv4_address: 172.16.239.21
  epirus-web:
    image: web3labs/epirus-free-web:latest
    ports:
      - 3000:3000
    environment:
      - API_URL=/api
      - NEW_RELIC_LICENSE_KEY=dummy
    depends_on:
      - epirus-api
    networks:
      app_net:
        ipv4_address: 172.16.239.22
  epirus-ingestion:
    image: web3labs/epirus-free-ingestion:latest
    environment:
      - NODE_ENDPOINT=http://ibet-validator-0:8545
      - MONGO_CLIENT_URI=mongodb://epirus-mongodb:27017
      - MONGO_DB_NAME=epirus
    depends_on:
      - epirus-mongodb
      - ibet-validator-0
    networks:
      app_net:
        ipv4_address: 172.16.239.23
  epirus-nginx:
    image: nginx:latest
    ports:
      - 8080:80
    depends_on:
      - epirus-api
      - epirus-web
    networks:
      app_net:
        ipv4_address: 172.16.239.24
    entrypoint:
      - /bin/sh
      - -c
      - |
        cat <<'EOF' > /etc/nginx/nginx.conf
        events { }
        http {
          server {
            listen 80;
            charset utf-8;
            location /api/ {
              proxy_pass http://epirus-api:8090/;
            }
            location / {
              proxy_pass http://epirus-web:3000/;
            }
          }
        }
        EOF
        nginx -g "daemon off;" 
networks:
  app_net:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.16.239.0/24
